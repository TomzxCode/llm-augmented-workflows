# Plan for Issue #6: Workflow to Add Tags to Repository

## Issue Summary

The project uses `plan-needed` and `plan-approval` labels to trigger planning and implementation workflows. Currently, there's no automated way to ensure these labels exist in the repository when workflows are added or modified. The goal is to create a workflow that automatically creates/updates these labels, preferably triggered by workflow changes, with minimal over-triggering.

## Feasibility Assessment

**Status: Feasible with manual trigger**

### Technical Constraints

GitHub Actions does not provide a native trigger for detecting when workflow files are added or modified. The available workflow triggers that could be considered:

1. **`push` trigger with `paths` filter**: Would trigger on any push that modifies `.github/workflows/**`, but this would trigger the label setup workflow on EVERY workflow change, which is excessive
2. **`workflow_dispatch` trigger**: Manual trigger that allows on-demand execution
3. **`schedule` trigger**: Would run periodically, but this is wasteful and unnecessary
4. **Repository creation**: No direct trigger exists for this event

### Recommended Approach

Given the constraints and the requirement to "not overtrigger the workflow as much as possible," the most practical solution is:

**Primary Solution**: Create a `workflow_dispatch` (manually triggered) workflow that:
- Creates/updates the required labels with proper names, colors, and descriptions
- Can be run on-demand when needed (e.g., when initially setting up the repo, or when label requirements change)
- Is idempotent (safe to run multiple times)

**Alternative Enhancement**: Optionally add a `push` trigger filtered to `.github/workflows/**` that runs the label setup, but make it smart enough to:
- Only run when label-related configuration actually changes (check if `TRIGGER_LABEL` or `APPROVAL_LABEL` environment variables changed)
- Exit early if labels already exist with correct configuration

## Proposed Solution

### 1. Create `setup-labels.yml` Workflow

Create `.github/workflows/setup-labels.yml` that:

**Triggers**:
- `workflow_dispatch`: Manual trigger (primary)
- `push` with paths filter: Optional automatic trigger on workflow file changes

**Functionality**:
1. Read the label names from environment variables (matching the label names used in other workflows)
2. Check if labels already exist using `gh label list`
3. Create or update labels using `gh label create` or `gh label edit`
4. Use proper colors and descriptions for each label

**Label Specifications**:
- `plan-needed`:
  - Color: `#FFA500` (orange) - indicates action needed
  - Description: "Triggers automated plan generation for this issue"
- `plan-approved`:
  - Color: `#00FF00` (green) - indicates approval/go-ahead
  - Description: "Triggers automated implementation for this issue"

### 2. Make Labels Configurable

The workflow should:
- Use environment variables for label names (default: `plan-needed`, `plan-approved`)
- Match the configuration used in `claude-plan.yml`, `claude-implement.yml`, and `claude-plan-merged.yml`
- Allow customization without code changes

### 3. Implement Idempotency

The workflow must be safe to run multiple times:
- Check if label exists before creating
- Update label if it exists but configuration differs
- Skip if label exists and matches desired configuration

### 4. Provide Clear Logging

Output clear messages indicating:
- Which labels were created
- Which labels were updated
- Which labels already existed and were unchanged

## Implementation Steps

### Step 1: Create Workflow File
Create `.github/workflows/setup-labels.yml` with:
- `workflow_dispatch` trigger for manual execution
- Optional `push` trigger with paths filter for `.github/workflows/**`
- Proper permissions: `issues: write`
- Job checkout step (shallow clone)

### Step 2: Define Label Configuration
Set environment variables at workflow level:
```yaml
env:
  PLAN_TRIGGER_LABEL: 'plan-needed'
  PLAN_TRIGGER_COLOR: 'FFA500'
  PLAN_TRIGGER_DESCRIPTION: 'Triggers automated plan generation for this issue'
  APPROVAL_LABEL: 'plan-approved'
  APPROVAL_COLOR: '00FF00'
  APPROVAL_DESCRIPTION: 'Triggers automated implementation for this issue'
```

### Step 3: Implement Label Management Logic
Create a bash script or workflow steps that:
1. Check if each label exists: `gh label list --json name --jq '.[].name' | grep -q "^${LABEL_NAME}$"`
2. If label doesn't exist: `gh label create "${LABEL_NAME}" --color "${COLOR}" --description "${DESCRIPTION}"`
3. If label exists: `gh label edit "${LABEL_NAME}" --color "${COLOR}" --description "${DESCRIPTION}"`
4. Add error handling for API failures

### Step 4: Add Workflow Documentation
Update README.md section on "Set up labels" to:
- Mention the new `setup-labels.yml` workflow
- Provide instructions for manual trigger
- Explain automatic trigger behavior (if implemented)
- Note that labels can be customized via environment variables

### Step 5: Test the Workflow
1. Run workflow manually via workflow_dispatch
2. Verify labels are created correctly
3. Run again to verify idempotency
4. Test with modified label configuration

## Dependencies

### External Dependencies
- GitHub CLI (`gh`) - already used in other workflows
- Repository permissions: `issues: write`
- GitHub Actions runner environment

### Internal Dependencies
- Must align with label names used in:
  - `.github/workflows/claude-plan.yml` (`TRIGGER_LABEL`)
  - `.github/workflows/claude-implement.yml` (`APPROVAL_LABEL`)
  - `.github/workflows/claude-plan-merged.yml` (`APPROVAL_LABEL`)

## Risk Assessment

### Low Risk
- **Idempotency**: Using `gh label edit` is safe on existing labels
- **No workflow disruption**: Creating labels doesn't affect existing issues or workflows
- **Reversible**: Labels can be manually deleted if needed

### Considerations
- **Over-triggering with push trigger**: If we add automatic triggering on workflow file changes, it will run on every commit that touches workflows
  - Mitigation: Make it optional or very selective (check if label config actually changed)
  - Alternative: Stick with manual trigger only
- **Label name conflicts**: If repository already has labels with same names but different purposes
  - Mitigation: Document that setup will update existing labels
  - Alternative: Add a check/warning before modifying existing labels

### Recommendation
Start with **manual trigger only** (`workflow_dispatch`). If automatic triggering is desired later, add `push` trigger with intelligent filtering.

## Alternatives Considered

### Alternative 1: Composite Action
Create a reusable GitHub Action that sets up labels, which could be called from a workflow or used by other repositories.

**Pros**:
- More reusable across projects
- Better abstraction

**Cons**:
- More complex to implement
- Overkill for 2 simple labels
- Still needs a workflow to invoke it

**Verdict**: Not recommended for current scope

### Alternative 2: Initialization Script
Create a shell script in the repository that users run locally to set up labels.

**Pros**:
- Simple implementation
- No workflow triggers needed
- Full control over execution

**Cons**:
- Requires local GitHub CLI setup
- Not automated
- Requires manual authentication
- Doesn't integrate with CI/CD

**Verdict**: Not recommended - defeats the purpose of automation

### Alternative 3: Push Trigger with Diff Checking
Use `push` trigger but intelligently check if label configuration actually changed in the commit.

**Pros**:
- Automatic when needed
- Avoids unnecessary runs

**Cons**:
- Complex to implement (need to parse workflow files, compare env vars)
- Still triggers on workflow pushes even if just to check
- May miss changes if multiple workflows define labels differently

**Verdict**: Overly complex for the benefit provided

### Alternative 4: Combined Workflow
Add label setup as a preparatory step in `claude-plan.yml` that runs before plan generation.

**Pros**:
- Ensures labels exist before they're needed
- No separate workflow needed

**Cons**:
- Adds overhead to every plan generation
- Mixes concerns (planning vs. setup)
- Harder to maintain

**Verdict**: Not recommended - violates separation of concerns

## References

### Relevant Files
- `.github/workflows/claude-plan.yml:12-14` - Uses `TRIGGER_LABEL` environment variable
- `.github/workflows/claude-implement.yml:12` - Uses `APPROVAL_LABEL` environment variable
- `.github/workflows/claude-plan-merged.yml:13` - Uses `APPROVAL_LABEL` environment variable
- `README.md:56-58` - Documents label setup requirement

### GitHub Documentation
- GitHub Actions `workflow_dispatch` trigger for manual workflow execution
- GitHub CLI `gh label` commands for label management
- GitHub Actions permissions model for `issues: write`

### Similar Patterns in Repository
- All workflows use `gh` CLI for GitHub operations
- All workflows use shallow clone (`fetch-depth: 1`)
- All workflows define environment variables for configuration
