name: Claude Plan Review Response

on:
  pull_request_review_comment:
    types: [created]
  issue_comment:
    types: [created]
  workflow_call:
    secrets:
      ANTHROPIC_AUTH_TOKEN:
        required: false
      ANTHROPIC_API_KEY:
        required: false

permissions:
  contents: read
  pull-requests: write
  issues: write
  id-token: write

env:
  # Branch prefix for plan PRs
  PLAN_BRANCH_PREFIX: 'plan/'

jobs:
  check-plan:
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.check.outputs.should_run }}
    steps:
      - name: Check if this is a plan PR comment
        id: check
        uses: actions/github-script@v8
        with:
          script: |
            const eventName = context.eventName;
            const planBranchPrefix = '${{ env.PLAN_BRANCH_PREFIX }}';
            let shouldRun = false;
            let prNumber = null;
            let reason = '';

            if (eventName === 'pull_request_review_comment') {
              const branchRef = context.payload.pull_request.head.ref;
              prNumber = context.payload.pull_request.number;
              if (branchRef.startsWith(planBranchPrefix)) {
                shouldRun = true;
                reason = `Inline comment on plan PR branch "${branchRef}"`;
              } else {
                reason = `Inline comment on non-plan branch "${branchRef}"`;
              }
            } else if (eventName === 'issue_comment') {
              const issueBody = context.payload.issue.body || '';
              if (issueBody.includes('Plan for issue')) {
                shouldRun = true;
                reason = `Comment on issue with plan PR in body`;
                prNumber = context.payload.issue.number;
              } else {
                reason = `Comment on issue without plan PR in body`;
              }
            }

            core.info(`Event: ${eventName}`);
            core.info(`Should run: ${shouldRun}`);
            core.info(`Reason: ${reason}`);
            if (prNumber) core.info(`PR/Issue number: ${prNumber}`);

            core.setOutput('should_run', shouldRun.toString());
            core.setOutput('pr_number', prNumber || '');

  respond-to-comment:
    needs: check-plan
    if: needs.check-plan.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 1
          ref: ${{ github.event.repository.default_branch }}

      - name: Respond to review comment
        uses: anthropics/claude-code-action@v1
        env:
          ANTHROPIC_BASE_URL: ${{ vars.ANTHROPIC_BASE_URL }}
          ANTHROPIC_MODEL: ${{ vars.ANTHROPIC_MODEL }}
        with:
          claude_code_oauth_token: ${{ secrets.ANTHROPIC_AUTH_TOKEN }}
          github_token: ${{ secrets.GITHUB_TOKEN }}

          prompt: |
            REPO=${{ github.repository }}
            PR_NUMBER=${{ github.event.pull_request.number }}
            COMMENT_AUTHOR=${{ github.event.comment.user.login }}
            COMMENT_BODY=${{ github.event.comment.body }}
            COMMENT_TYPE=${{ github.event_name == 'pull_request_review_comment' && 'inline' || 'general' }}
            /review-plan-comment

          claude_args: |
            --allowedTools Skill,Glob,Grep,Read,Edit,Bash(gh:*),Bash(git:*)
            --max-turns 100
